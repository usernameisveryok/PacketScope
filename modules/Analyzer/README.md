# Analyzer æ¨¡å—è¯´æ˜

æœ¬æ¨¡å—é€šè¿‡ HTTP API æ¥å£å®ç°åè®®æ ˆä¸­åˆ†ç»„æ•°æ®æµåŠ¨æ•°é‡ã€å»¶è¿Ÿã€è·¨å±‚äº¤äº’é¢‘ç‡ã€ä¸¢åŒ…ç­‰å¤šç»´åº¦ä¿¡æ¯çš„å®æ—¶ç»Ÿè®¡ã€‚

## ğŸ“¦ ä¾èµ–

æœ¬æ¨¡å—ä¾èµ–[ BCC (BPF Compiler Collection)](https://github.com/iovisor/bcc)ï¼Œç”¨äºåŸºäº eBPF çš„å†…æ ¸æ€æ•°æ®é‡‡é›†ã€‚è¯·å…ˆæ ¹æ®å®˜æ–¹è¯´æ˜å®‰è£…ç³»ç»Ÿçº§ä¾èµ–ï¼š

ğŸ‘‰ å®‰è£… BCCï¼šè¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£ [INSTALL.md](https://github.com/iovisor/bcc/blob/master/INSTALL.md)

å®‰è£… Python ç¯å¢ƒå’Œä¾èµ–ï¼š
```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3 -m venv .venv

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source .venv/bin/activate

# å®‰è£… Python ä¾èµ–
pip install -r requirements.txt

```

## ğŸš€ è¿è¡Œ
è¿è¡Œè„šæœ¬å‰éœ€å…·æœ‰ç®¡ç†å‘˜æƒé™ï¼Œå¹¶ç¡®ä¿ç³»ç»Ÿæ”¯æŒ eBPFï¼ˆLinux å†…æ ¸ â‰¥ 6.8ï¼‰ï¼š

```bash
# åˆ‡æ¢ä¸º root ç”¨æˆ·ï¼ˆæˆ–ä½¿ç”¨ sudoï¼‰
sudo -s

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source .venv/bin/activate

# å¯åŠ¨ç›‘æ§è„šæœ¬
python monitor.py

```

è„šæœ¬å°†ä¼šåœ¨æœ¬åœ°å¯åŠ¨ä¸€ä¸ª HTTP æœåŠ¡ï¼Œç›‘å¬ç«¯å£ 5000ï¼Œç”¨äºå±•ç¤ºæˆ–å¯¼å‡ºç›‘æ§æ•°æ®ã€‚

## æ¥å£åˆ—è¡¨

### /api/NumLatencyFrequency

åŠŸèƒ½ï¼šç»Ÿè®¡æŒ‡å®šäº”å…ƒç»„åœ¨é“¾è·¯å±‚ã€ç½‘ç»œå±‚ã€ä¼ è¾“å±‚çš„æ•°æ®åŒ…æµåŠ¨æƒ…å†µã€ä¸¢åŒ…ç‡ã€è·¨å±‚å»¶è¿Ÿä¸è·¨å±‚äº¤äº’é¢‘ç‡

è¯·æ±‚ç¤ºä¾‹ï¼š

```
{"type":"NumLatencyFrequency","params":{"ipv4":true,"ipv6":false,"sip":"192.168.126.128","dip":"103.143.17.156","sport":57892,"dport":443,"protocol":"tcp"}}
```

è¾“å‡ºç¤ºä¾‹ï¼š

```
{"type": "NumLatencyFrequency", "data": "{\"crosslayer\": \"linknetwork\", \"direction\": \"send\", \"type\": \"ipv4\", \"pid\": 3206, \"pid_name\": \"Socket Thread\", \"saddr\": \"192.168.126.128\", \"daddr\": \"103.143.17.156\", \"sport\": 57892, \"dport\": 443, \"LAT(ms)\": 0.01, \"frequency(s)\": 35.3051937862859}\n"}
{"type": "NumLatencyFrequency", "data": "{\"crosslayer\": \"linknetwork\", \"direction\": \"receive\", \"type\": \"ipv4\", \"pid\": 3617, \"pid_name\": \"StreamT~ns #162\", \"saddr\": \"103.143.17.156\", \"daddr\": \"192.168.126.128\", \"sport\": 443, \"dport\": 57892, \"LAT(ms)\": 0.099, \"frequency(s)\": 35.30391275226362}\n"}
{"type": "NumLatencyFrequency", "data": "{\"crosslayer\": \"networktrans\", \"direction\": \"send\", \"type\": \"ipv4\", \"pid\": -1, \"pid_name\": \"NULL\", \"saddr\": \"192.168.126.128\", \"daddr\": \"103.143.17.156\", \"sport\": 57892, \"dport\": 443, \"LAT(ms)\": 0, \"frequency(s)\": 0}"}
{"type": "NumLatencyFrequency", "data": "{\"crosslayer\": \"networktrans\", \"direction\": \"receive\", \"type\": \"ipv4\", \"pid\": 3617, \"pid_name\": \"StreamT~ns #162\", \"saddr\": \"103.143.17.156\", \"daddr\": \"192.168.126.128\", \"sport\": 443, \"dport\": 57892, \"LAT(ms)\": 0.269, \"frequency(s)\": 35.30557465216654}\n"}
{"type": "NumLatencyFrequency", "data": "{\"crosslayer\": \"linktrans\", \"direction\": \"send\", \"type\": \"ipv4\", \"pid\": -1, \"pid_name\": \"NULL\", \"saddr\": \"192.168.126.128\", \"daddr\": \"103.143.17.156\", \"sport\": 57892, \"dport\": 443, \"LAT(ms)\": 0, \"frequency(s)\": 0}"}
{"type": "NumLatencyFrequency", "data": "{\"crosslayer\": \"linktrans\", \"direction\": \"receive\", \"type\": \"ipv4\", \"pid\": 3617, \"pid_name\": \"StreamT~ns #162\", \"saddr\": \"103.143.17.156\", \"daddr\": \"192.168.126.128\", \"sport\": 443, \"dport\": 57892, \"LAT(ms)\": 0.308, \"frequency(s)\": 35.30560927674498}\n"}
{"type": "NumLatencyFrequency", "data": "{\"layer\": \"trans\", \"direction\": \"send\", \"type\": \"ipv4\", \"pid\": 3206, \"saddr\": \"192.168.126.128\", \"daddr\": \"103.143.17.156\", \"sport\": 37630, \"dport\": 443, \"num\": 2, \"pps(s)\": 2.4280114828756396}\n"}
{"type": "NumLatencyFrequency", "data": "{\"layer\": \"trans\", \"direction\": \"receive\", \"type\": \"ipv4\", \"pid\": 3206, \"saddr\": \"103.143.17.156\", \"daddr\": \"192.168.126.128\", \"sport\": 443, \"dport\": 57892, \"num\": 35, \"pps(s)\": 35.30557465216654}\n"}
{"type": "NumLatencyFrequency", "data": "{\"layer\": \"network\", \"direction\": \"send\", \"type\": \"ipv4\", \"pid\": 3206, \"saddr\": \"192.168.126.128\", \"daddr\": \"103.143.17.156\", \"sport\": 37630, \"dport\": 443, \"num\": 2, \"pps(s)\": 2.428141185078587}\n"}
{"type": "NumLatencyFrequency", "data": "{\"layer\": \"network\", \"direction\": \"receive\", \"type\": \"ipv4\", \"pid\": 3617, \"saddr\": \"103.143.17.156\", \"daddr\": \"192.168.126.128\", \"sport\": 443, \"dport\": 57892, \"num\": 35, \"pps(s)\": 35.303947373582446}\n"}
{"type": "NumLatencyFrequency", "data": "{\"layer\": \"link\", \"direction\": \"send\", \"type\": \"ipv4\", \"pid\": 3206, \"saddr\": \"192.168.126.128\", \"daddr\": \"103.143.17.156\", \"sport\": 37630, \"dport\": 443, \"num\": 2, \"pps(s)\": 2.428158872816276}\n"}
{"type": "NumLatencyFrequency", "data": "{\"layer\": \"link\", \"direction\": \"receive\", \"type\": \"ipv4\", \"pid\": 3617, \"saddr\": \"103.143.17.156\", \"daddr\": \"192.168.126.128\", \"sport\": 443, \"dport\": 57892, \"num\": 35, \"pps(s)\": 35.30346268129799}\n"}
{"type": "NumLatencyFrequency", "data": "{\"type\": \"ipv4\", \"pid\": 0, \"saddr\": \"103.143.17.156\", \"daddr\": \"192.168.126.128\", \"sport\": 443, \"dport\": 57244, \"drop(s)\": 1.2019447465999988}\n"}
```

è¿”å›å€¼è¯´æ˜ï¼š

```
1ï¼‰
"crosslayer": "linknetwork",è¡¨ç¤º"é“¾è·¯å±‚ä¸ç½‘ç»œå±‚"ä¹‹é—´çš„äº¤äº’æƒ…å†µï¼›
"direction": "send",è¡¨ç¤ºå‘åŒ…æƒ…å†µï¼Œ
"type": "ipv4", è¡¨ç¤ºåè®®æ˜¯ipv4è¿˜æ˜¯ipv6
"pid": -1, è¡¨ç¤ºçº¿ç¨‹id,è‹¥ä¸º-1,åˆ™è¡¨ç¤ºå½“å‰äº”å…ƒç»„æ— ä¸¢åŒ…æƒ…å†µ
"pid_name": "Socket Thread", è¡¨ç¤ºçº¿ç¨‹åç§°ï¼Œ
"saddr": "192.168.126.128", 
"daddr": "103.143.17.156", 
"sport": 57892,
"dport": 443,

"LAT(ms)": 0.01,  è¡¨ç¤ºç»™å®šäº”å…ƒç»„ï¼Œæ•°æ®åŒ…ä»ç½‘ç»œå±‚åˆ°é“¾è·¯å±‚çš„å»¶æ—¶æ—¶é—´ï¼Œå•ä½ms  
"frequency(s)": 35.3051937862859,   è¡¨ç¤ºç»™å®šäº”å…ƒç»„ï¼Œæ•°æ®åŒ…ä»ç½‘ç»œå±‚åˆ°é“¾è·¯å±‚çš„äº¤äº’é¢‘ç‡ï¼Œå•ä½s  

2ï¼‰
"crosslayer": "linknetwork",è¡¨ç¤º"é“¾è·¯å±‚ä¸ç½‘ç»œå±‚"ä¹‹é—´çš„äº¤äº’æƒ…å†µï¼›
"direction": "receive",è¡¨ç¤ºæ”¶åŒ…æƒ…å†µï¼Œ

å…¶ä½™å­—æ®µå«ä¹‰åŒä¸Šï¼Œæ³¨æ„ï¼š
"LAT(ms)": 0.099,  è¡¨ç¤ºç»™å®šäº”å…ƒç»„ï¼Œæ•°æ®åŒ…ä»é“¾è·¯å±‚åˆ°ç½‘ç»œå±‚çš„å»¶æ—¶æ—¶é—´ï¼Œå•ä½ms  
"frequency(s)": 35.303..,   è¡¨ç¤ºç»™å®šäº”å…ƒç»„ï¼Œæ•°æ®åŒ…ä»é“¾è·¯å±‚åˆ°ç½‘ç»œå±‚çš„äº¤äº’é¢‘ç‡ï¼Œå•ä½s  

3ï¼‰
"crosslayer": "networktrans",è¡¨ç¤º"ç½‘ç»œå±‚ä¸ä¼ è¾“å±‚"ä¹‹é—´çš„äº¤äº’æƒ…å†µï¼›
"direction": "send",è¡¨ç¤ºå‘åŒ…æƒ…å†µï¼Œ

å…¶ä½™å­—æ®µå«ä¹‰åŒä¸Šï¼Œæ³¨æ„ï¼š
"LAT(ms)": 0,  è¡¨ç¤ºç»™å®šäº”å…ƒç»„ï¼Œæ•°æ®åŒ…ä»ä¼ è¾“å±‚åˆ°ç½‘ç»œå±‚çš„å»¶æ—¶æ—¶é—´ï¼Œå•ä½ms  
"frequency(s)": 0,   è¡¨ç¤ºç»™å®šäº”å…ƒç»„ï¼Œæ•°æ®åŒ…ä»ä¼ è¾“å±‚åˆ°ç½‘ç»œå±‚çš„äº¤äº’é¢‘ç‡ï¼Œå•ä½s  

4ï¼‰
"crosslayer": "networktrans",è¡¨ç¤º"ç½‘ç»œå±‚ä¸ä¼ è¾“å±‚"ä¹‹é—´çš„äº¤äº’æƒ…å†µï¼›
"direction": "receive",è¡¨ç¤ºæ”¶åŒ…æƒ…å†µï¼Œ

å…¶ä½™å­—æ®µå«ä¹‰åŒä¸Šï¼Œæ³¨æ„ï¼š
"LAT(ms)": 0,  è¡¨ç¤ºç»™å®šäº”å…ƒç»„ï¼Œæ•°æ®åŒ…ä»ç½‘ç»œå±‚åˆ°ä¼ è¾“å±‚çš„å»¶æ—¶æ—¶é—´ï¼Œå•ä½ms  
"frequency(s)": 0,   è¡¨ç¤ºç»™å®šäº”å…ƒç»„ï¼Œæ•°æ®åŒ…ä»ç½‘ç»œå±‚åˆ°ä¼ è¾“å±‚çš„äº¤äº’é¢‘ç‡ï¼Œå•ä½s  

5ï¼‰
"crosslayer": "linktrans",è¡¨ç¤º"é“¾è·¯ä¸ä¼ è¾“å±‚"ä¹‹é—´çš„äº¤äº’æƒ…å†µï¼›
"direction": "send",è¡¨ç¤ºå‘åŒ…æƒ…å†µï¼Œ

å…¶ä½™å­—æ®µå«ä¹‰åŒä¸Šï¼Œæ³¨æ„ï¼š
"LAT(ms)": 0,  è¡¨ç¤ºç»™å®šäº”å…ƒç»„ï¼Œæ•°æ®åŒ…ä»ä¼ è¾“å±‚åˆ°é“¾è·¯å±‚çš„å»¶æ—¶æ—¶é—´ï¼Œå•ä½ms  
"frequency(s)": 0,   è¡¨ç¤ºç»™å®šäº”å…ƒç»„ï¼Œæ•°æ®åŒ…ä»ä¼ è¾“å±‚åˆ°é“¾è·¯å±‚çš„äº¤äº’é¢‘ç‡ï¼Œå•ä½s

6ï¼‰
"crosslayer": "linktrans",è¡¨ç¤º"é“¾è·¯ä¸ä¼ è¾“å±‚"ä¹‹é—´çš„äº¤äº’æƒ…å†µï¼›
"direction": "receive",è¡¨ç¤ºæ”¶åŒ…æƒ…å†µï¼Œ

å…¶ä½™å­—æ®µå«ä¹‰åŒä¸Šï¼Œæ³¨æ„ï¼š
"LAT(ms)": 0.308,  è¡¨ç¤ºç»™å®šäº”å…ƒç»„ï¼Œæ•°æ®åŒ…ä»é“¾è·¯å±‚åˆ°ä¼ è¾“å±‚çš„å»¶æ—¶æ—¶é—´ï¼Œå•ä½ms  
"frequency(s)": 35.305...,   è¡¨ç¤ºç»™å®šäº”å…ƒç»„ï¼Œæ•°æ®åŒ…ä»é“¾è·¯å±‚åˆ°ä¼ è¾“å±‚çš„äº¤äº’é¢‘ç‡ï¼Œå•ä½s
  
7ï¼‰
"layer": "trans",è¡¨ç¤º"ä¼ è¾“å±‚æ•°æ®åŒ…æ•°é‡"ï¼›
"direction": "send",è¡¨ç¤ºå‘åŒ…

å…¶ä½™å­—æ®µå«ä¹‰åŒä¸Šï¼Œæ³¨æ„ï¼š
"num":2,  è¡¨ç¤ºç»™å®šäº”å…ƒç»„ï¼Œä¼ è¾“å±‚å¤„ç†çš„æ•°æ®åŒ…æ•°ç›®  
"pps(s)": 2.42...,   è¡¨ç¤ºç»™å®šäº”å…ƒç»„ï¼Œä¼ è¾“å±‚å¤„ç†çš„æ•°æ®åŒ…çš„é¢‘ç‡ï¼Œå•ä½ä¸ºs 

8)
"layer": "trans",è¡¨ç¤º"ä¼ è¾“å±‚æ•°æ®åŒ…æ•°é‡"ï¼›
"direction": "receive",è¡¨ç¤ºå‘åŒ…

å…¶ä½™å­—æ®µå«ä¹‰åŒä¸Šï¼Œæ³¨æ„ï¼š
"num":35  è¡¨ç¤ºç»™å®šäº”å…ƒç»„ï¼Œä¼ è¾“å±‚å¤„ç†çš„æ•°æ®åŒ…æ•°ç›®  
"pps(s)": 35.30...,   è¡¨ç¤ºç»™å®šäº”å…ƒç»„ï¼Œä¼ è¾“å±‚å¤„ç†çš„æ•°æ®åŒ…çš„é¢‘ç‡ï¼Œå•ä½ä¸ºs 
  
9)
"layer": "network",è¡¨ç¤º"ç½‘ç»œå±‚æ•°æ®åŒ…æ•°é‡"ï¼›
"direction": "send",è¡¨ç¤ºå‘åŒ…

å…¶ä½™å­—æ®µå«ä¹‰åŒä¸Šï¼Œæ³¨æ„ï¼š
"num":2,  è¡¨ç¤ºç»™å®šäº”å…ƒç»„ï¼Œç½‘ç»œå±‚å¤„ç†çš„æ•°æ®åŒ…æ•°ç›®  
"pps(s)": 2.42...,   è¡¨ç¤ºç»™å®šäº”å…ƒç»„ï¼Œç½‘ç»œå±‚å¤„ç†çš„æ•°æ®åŒ…çš„é¢‘ç‡ï¼Œå•ä½ä¸ºs 

10)
"layer": "network",è¡¨ç¤º"ç½‘ç»œå±‚æ•°æ®åŒ…æ•°é‡"ï¼›
"direction": "receive",è¡¨ç¤ºå‘åŒ…

å…¶ä½™å­—æ®µå«ä¹‰åŒä¸Šï¼Œæ³¨æ„ï¼š
"num":35  è¡¨ç¤ºç»™å®šäº”å…ƒç»„ï¼Œç½‘ç»œå±‚å¤„ç†çš„æ•°æ®åŒ…æ•°ç›®  
"pps(s)": 35.30...,   è¡¨ç¤ºç»™å®šäº”å…ƒç»„ï¼Œç½‘ç»œå±‚å¤„ç†çš„æ•°æ®åŒ…çš„é¢‘ç‡ï¼Œå•ä½ä¸ºs 
  
11)
"layer": "link",è¡¨ç¤º"é“¾è·¯å±‚æ•°æ®åŒ…æ•°é‡"ï¼›
"direction": "send",è¡¨ç¤ºå‘åŒ…

å…¶ä½™å­—æ®µå«ä¹‰åŒä¸Šï¼Œæ³¨æ„ï¼š
"num":2,  è¡¨ç¤ºç»™å®šäº”å…ƒç»„ï¼Œé“¾è·¯å±‚å¤„ç†çš„æ•°æ®åŒ…æ•°ç›®  
"pps(s)": 2.42...,   è¡¨ç¤ºç»™å®šäº”å…ƒç»„ï¼Œé“¾è·¯å±‚å¤„ç†çš„æ•°æ®åŒ…çš„é¢‘ç‡ï¼Œå•ä½ä¸ºs 

12)
"layer": "link",è¡¨ç¤º"é“¾è·¯å±‚æ•°æ®åŒ…æ•°é‡"ï¼›
"direction": "receive",è¡¨ç¤ºå‘åŒ…

å…¶ä½™å­—æ®µå«ä¹‰åŒä¸Šï¼Œæ³¨æ„ï¼š
"num":35  è¡¨ç¤ºç»™å®šäº”å…ƒç»„ï¼Œé“¾è·¯å±‚å¤„ç†çš„æ•°æ®åŒ…æ•°ç›®  
"pps(s)": 35.30...,   è¡¨ç¤ºç»™å®šäº”å…ƒç»„ï¼Œé“¾è·¯å±‚å¤„ç†çš„æ•°æ®åŒ…çš„é¢‘ç‡ï¼Œå•ä½ä¸ºs   
  

13)
å…¶ä½™å­—æ®µå«ä¹‰åŒä¸Šï¼Œæ³¨æ„ï¼š
"drops(s)": 1.20...,   è¡¨ç¤ºç»™å®šäº”å…ƒç»„ï¼Œtcpçš„ä¸¢åŒ…ç‡ï¼Œå•ä½ä¸ºs
```


{"type": "NumLatencyFrequency", "data": "{\"layer\": \"link\", \"direction\": \"receive\", \"type\": \"ipv4\", \"pid\": -1, \"saddr\": \"103.143.17.156\", \"daddr\": \"192.168.126.128\", \"sport\": 443, \"dport\": 57892, \"num\": 0, \"pps(s)\": 0}"}

{"type": "NumLatencyFrequency", "data": "{\"layer\": \"network\", \"direction\": \"receive\", \"type\": \"ipv4\", \"pid\": -1, \"saddr\": \"103.143.17.156\", \"daddr\": \"192.168.126.128\", \"sport\": 443, \"dport\": 57892, \"num\": 0, \"pps(s)\": 0}"}

{"type": "NumLatencyFrequency", "data": "{\"layer\": \"trans\", \"direction\": \"receive\", \"type\": \"ipv4\", \"pid\": -1, \"saddr\": \"103.143.17.156\", \"daddr\": \"192.168.126.128\", \"sport\": 443, \"dport\": 57892, \"num\": 0, \"pps(s)\": 0}"}

{"type": "NumLatencyFrequency", "data": "{\"crosslayer\": \"linknetwork\", \"direction\": \"receive\", \"type\": \"ipv4\", \"pid\": -1, \"pid_name\": \"NULL\", \"saddr\": \"103.143.17.156\", \"daddr\": \"192.168.126.128\", \"sport\": 443, \"dport\": 57892, \"LAT(ms)\": 0, \"frequency(s)\": 0}"}

{"type": "NumLatencyFrequency", "data": "{\"crosslayer\": \"networktrans\", \"direction\": \"receive\", \"type\": \"ipv4\", \"pid\": -1, \"pid_name\": \"NULL\", \"saddr\": \"103.143.17.156\", \"daddr\": \"192.168.126.128\", \"sport\": 443, \"dport\": 57892, \"LAT(ms)\": 0, \"frequency(s)\": 0}"}

{"type": "NumLatencyFrequency", "data": "{\"crosslayer\": \"linktrans\", \"direction\": \"receive\", \"type\": \"ipv4\", \"pid\": -1, \"pid_name\": \"NULL\", \"saddr\": \"103.143.17.156\", \"daddr\": \"192.168.126.128\", \"sport\": 443, \"dport\": 57892, \"LAT(ms)\": 0, \"frequency(s)\": 0}"}

{"type": "NumLatencyFrequency", "data": "{\"type\": \"ipv4\", \"pid\": -1, \"saddr\": \"103.143.17.156\", \"daddr\": \"192.168.126.128\", \"sport\": 443, \"dport\": 57892, \"drop(s)\": 0}"}